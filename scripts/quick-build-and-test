#!/bin/bash
set -exuo pipefail

rmmod sysdig-probe || true
rmmod sysdigcloud-probe || true
rm -rf agent/build || true
rm -rf sysdig/build || true
agent/bootstrap-agent
agent/bootstrap-sysdig

make -C agent/build/debug VERBOSE=1
make -C sysdig/build/debug VERBOSE=1
insmod sysdig/driver/sysdigcloud-probe.ko
cd agent/build/debug/test
./tests
cd -
insmod sysdig/driver/sysdig-probe.ko
cd sysdig/build/debug/userspace/sysdig
./sysdig -n 50
./sysdig -cl
./sysdig -cstdout -n 50
cd -
rmmod sysdig-probe
rmmod sysdigcloud-probe

make -C agent/build/release VERBOSE=1
make -C sysdig/build/release VERBOSE=1
insmod sysdig/driver/sysdigcloud-probe.ko
cd agent/build/release/test
./tests
cd -
insmod sysdig/driver/sysdig-probe.ko
cd sysdig/build/release/userspace/sysdig
./sysdig -n 50
./sysdig -cl
./sysdig -cstdout -n 50
cd -
rmmod sysdig-probe
rmmod sysdigcloud-probe

