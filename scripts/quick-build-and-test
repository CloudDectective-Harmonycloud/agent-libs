#!/bin/bash
set -exuo pipefail

rmmod sysdig-probe || true
rmmod sysdigcloud-probe || true
rm -rf agent/build || true
rm -rf sysdig/build || true
agent/bootstrap-agent
agent/bootstrap-sysdig

make -C agent/build/debug VERBOSE=1
make -C sysdig/build/debug VERBOSE=1
insmod sysdig/driver/sysdigcloud-probe.ko
cd agent/build/debug/test
./tests
cd -
insmod sysdig/driver/sysdig-probe.ko
cd sysdig/build/debug/userspace/sysdig
./sysdig -n 50
./sysdig -cl
./sysdig -cstdout -n 50
cd -
rmmod sysdig-probe
rmmod sysdigcloud-probe

make -C agent/build/release VERBOSE=1
make -C sysdig/build/release VERBOSE=1
insmod sysdig/driver/sysdigcloud-probe.ko
cd agent/build/release/test
./tests
cd -
insmod sysdig/driver/sysdig-probe.ko
cd sysdig/build/release/userspace/sysdig
./sysdig -n 50
./sysdig -cl
./sysdig -cstdout -n 50
cd -
rmmod sysdig-probe
rmmod sysdigcloud-probe

# Integration tests
if [ `uname -m` == "x86_64" ]; then
  make -C agent/build/release VERBOSE=1 package
  mkdir -p agent/build/integtest
  pushd agent/build/integtest
  cp -r ../../integtest/* .

  # build agent docker container
  cp -r "../../docker/local" agent-docker
  cp ../release/draios-0.1.1dev-x86_64-agent.deb agent-docker/
  pushd agent-docker
  docker rm -fv sysdig-agent || true
  docker rmi agent debian:unstable || true
  docker build -t agent .
  popd

  # run tests
  docker build -t integtest . # Should be cached
  docker run --rm -v /var/run/docker.sock:/var/run/docker.sock -v $PWD/:/code integtest

  popd
fi
