#!/bin/bash

if [ -z "$AGENT_VERSION" ]
then
	echo "AGENT_VERSION must be set" >&2
	exit 1
fi

if [ -z "$S3_BUCKET" ]
then
	echo "S3_BUCKET must be set" >&2
	exit 1
fi

if [ $# -ne 1 ]
then
    echo "Usage: $0 repo-name" >&2
    exit 1
fi

REPO_NAME=$1

SCRIPTS_DIR=$(dirname $(readlink -f $0))
if [ -z "$WORKSPACE" ]
then
	WORKSPACE=$SCRIPTS_DIR/../../../..
fi

set -xeuo pipefail

SOURCE=$WORKSPACE
INSTALL_DIR=$WORKSPACE/install
OUT=$WORKSPACE/out
BUILD=$WORKSPACE/build
PIPCACHE=$WORKSPACE/pipcache
REPO_DIR=$WORKSPACE/repo
# docker run -it --rm -v $WORKSPACE:/workspace busybox rm -vrf /workspace/build /workspace/pipcache

DRIVER_BUILD=$WORKSPACE/driver

AGENT_BUILD_COMMIT="`git -C $SOURCE/agent rev-parse --short HEAD`"
AGENT_BUILD_DATE="`date`"

sudo rm -rf $INSTALL_DIR
mkdir -p $INSTALL_DIR
sudo rm -rf $OUT
mkdir -p $OUT
sudo rm -rf $BUILD
mkdir -p $BUILD

rm -rf $DRIVER_BUILD
mkdir -p $DRIVER_BUILD
(
cd $DRIVER_BUILD
cmake $WORKSPACE/agent
make -C driver
)

# since we need sudo anyway, this may be too hacky. just use insmod/rmmod?
docker run -i --rm --privileged -v $DRIVER_BUILD/driver:/driver busybox rmmod sysdigcloud-probe
docker run -i --rm --privileged -v $DRIVER_BUILD/driver:/driver busybox insmod /driver/sysdigcloud-probe.ko

docker pull quay.io/sysdig/agent-builder:release-$AGENT_VERSION
docker images -q -f 'dangling=true' | xargs --no-run-if-empty docker rmi -f
docker run -i --rm -e MAKE_JOBS=$(nproc) -e AGENT_VERSION -e AGENT_BUILD_COMMIT -e AGENT_BUILD_DATE -v $SOURCE:/draios:ro -v $INSTALL_DIR:/opt/draios -v $OUT:/out -v /var/run/docker.sock:/var/run/docker.sock -v $BUILD:/code/agent/build -v $PIPCACHE:/root/.cache quay.io/sysdig/agent-builder:release-$AGENT_VERSION release
docker run -i --rm -v $OUT:/out busybox chown -R `id -u`:`id -g` /out

sudo $SCRIPTS_DIR/run-tests $INSTALL_DIR

docker run -i --rm --privileged -v $PWD/driver:/driver busybox rmmod sysdigcloud-probe

$SCRIPTS_DIR/upload-agent $REPO_NAME $OUT $REPO_DIR $S3_BUCKET

# Cleanup after the build
sudo rm -rf $INSTALL_DIR
sudo rm -rf $OUT
sudo rm -rf $BUILD
sudo rm -rf $DRIVER_BUILD
