/* vim:expandtab:sw=4:ts=4:sts=4
*/

pipeline {

    parameters {
        string(name: 'RELEASE_VERSION', defaultValue: "", description: "Agent version, comes from upstream job")
    }

    agent { label 'agent-docker-builder' }
    stages {
        stage('Bump Agent version in Helm Chart') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'github-jenkins-user-token', passwordVariable: 'GITHUB_PASSWORD', usernameVariable: 'GITHUB_USERNAME')]) {
                    dir('charts') {
                        checkout([$class: 'GitSCM', userRemoteConfigs: [[credentialsId: 'github-jenkins-user-token', url: "https://$GITHUB_PASSWORD@github.com/sysdiglabs/charts.git"]]])

                        sh label: '', script: '''
                            #!/usr/bin/bash -e
                            git config user.name "$GITHUB_USERNAME"
                            git config user.email "$GITHUB_USERNAME@sysdig.com"

                            cd charts/sysdig
                            bash ../../scripts/chart-version-bump.sh
                            bash ../../scripts/sysdig/image-version-bump.sh -v AGENT_VERSION=$RELEASE_VERSION
                            sed -i '/| `image.tag`/{!b;s/`[0-9\\.]\\+`/`'$RELEASE_VERSION'`/}' README.md
                            git add values.yaml Chart.yaml README.md

                            MSG="[sysdig] bump agent version to $RELEASE_VERSION"
                            git commit -m "$MSG"

                            BRANCH_NAME=sysdig-$RELEASE_VERSION
                            git branch $BRANCH_NAME
                            git push origin $BRANCH_NAME

                            curl -s \
                                -H "Accept: application/vnd.github.v3+json" \
                                -H "Authorization: token $GITHUB_PASSWORD" \
                                -X POST https://api.github.com/repos/sysdiglabs/charts/pulls \
                                -o pull.json \
                                -d '{
                                    "base": "master",
                                    "head": "'"$BRANCH_NAME"'",
                                    "title": "'"$MSG"'"
                                }'

                            PR_NO=$(grep -Po '(?<="number": )[^,]*' pull.json)
                            for i in $(seq 1 15); do
                                sleep 60;
                                echo "Waiting for checks..."
                                curl -s \
                                    -H "Accept: application/vnd.github.v3+json" \
                                    https://api.github.com/repos/sysdiglabs/charts/pulls/${PR_NO} \
                                    -o pull.json
                                grep -q '"state": "open"' pull.json && \
                                grep -q '"mergeable": true' pull.json && \
                                grep -q '"mergeable_state": "clean"' pull.json && \
                                CAN_MERGE=true && break
                            done
                            if [ $CAN_MERGE ]; then
                                curl -s \
                                    -H "Accept: application/vnd.github.v3+json" \
                                    -H "Authorization: token $GITHUB_PASSWORD" \
                                    -X PUT https://api.github.com/repos/sysdiglabs/charts/pulls/${PR_NO}/merge \
                                    -d '{ "merge_method": "squash" }'
                            else
                                echo "Unable to merge automatically"
                                echo
                                cat pull.json
                                exit 1
                            fi
                        '''
                    }
                }
            }
        }
    }
    post {
        always {
            cleanWs deleteDirs: true, notFailBuild: true
        }
    }
}
