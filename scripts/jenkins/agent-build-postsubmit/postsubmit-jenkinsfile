
pipeline {
	agent { label 'agent-docker-builder' }
	options {
	    timeout(time: 60, unit: 'MINUTES')
	}
	stages {
		stage('Check out dependencies') {
			steps {

				dir('agent') {
					checkout scm
				}
				dir('oss-falco') {
					checkout([$class: 'GitSCM', branches: [[name: 'master']], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: 'github-jenkins-user-token', url: 'https://github.com/draios/oss-falco']]])
				}
				dir('sysdig') {
					checkout([$class: 'GitSCM', branches: [[name: 'dev']], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: 'github-jenkins-user-token', url: 'https://github.com/draios/sysdig']]])
				}
				dir('protorepo') {
					checkout([$class: 'GitSCM', branches: [[name: 'master']], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: 'github-jenkins-user-token', url: 'https://github.com/draios/protorepo']]])
				}
				dir('prometheus') {
					checkout([$class: 'GitSCM', branches: [[name: 'master']], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: 'github-jenkins-user-token', url: 'https://github.com/draios/prometheus']]])
				}
			}
		}
		stage('Build Internal Container') {
			steps {
				script{
					docker.withRegistry("https://docker.internal.sysdig.com", 'jenkins-artifactory') {
						sh('./agent/scripts/jenkins/agent-build-postsubmit/build-internal-and-push')
					}
				}
			}
		}
		stage('Build Helper Containers') {
			steps {
				script{
					docker.withRegistry("https://docker.internal.sysdig.com", 'jenkins-artifactory') {
						sh('./agent/scripts/jenkins/agent-build-postsubmit/generate-helpers-and-push')
					}
				}
			}
		}
	}
	post {
		always {
			cleanWs deleteDirs: true, notFailBuild: true
		}
	}
}
