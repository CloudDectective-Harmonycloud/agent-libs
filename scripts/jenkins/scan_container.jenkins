pipeline {
    agent { label 'agent-docker-builder' }

    stages {

    stage('Pull Container') {
        steps {
            withCredentials([usernamePassword(credentialsId: 'docker-hub', passwordVariable: 'DOCKER_PASSWORD', usernameVariable: 'DOCKER_USERNAME'), usernamePassword(credentialsId: 'QUAY', passwordVariable: 'QUAY_PASSWORD', usernameVariable: 'QUAY_USERNAME')]) {
                script {
                    docker.withRegistry("https://docker.internal.sysdig.com", 'jenkins-artifactory') {

                        sh label: '', script: '''
                            echo "$DOCKER_PASSWORD" | docker login docker.io -u="$DOCKER_USERNAME" --password-stdin
                            echo "$QUAY_PASSWORD" | docker login quay.io -u="$QUAY_USERNAME" --password-stdin
                            docker pull $CONTAINER_NAME
                            echo $CONTAINER_NAME > file_with_name_of_container
                        '''
                    }
                }
            }
        }
    }
    stage('Scan Container') {
        steps {
            sysdig engineCredentialsId: 'prodmon-sdc-admin', engineRetries: '10000', name: 'file_with_name_of_container'
        }
    }

    }

    post {
        always {
            sh label: '', script: """
                docker rmi ${params.CONTAINER_NAME}
            """
            cleanWs deleteDirs: true, notFailBuild: true
        }
    }
}

