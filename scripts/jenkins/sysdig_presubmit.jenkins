pipeline {
	agent { label 'agent-docker-builder' }
	stages {
		stage('Check out dependencies') {
			steps {
				dir('agent') {
					checkout scm
				}
				dir('sysdig') {
					checkout([$class: 'GitSCM', branches: [[name: 'dev']], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: 'github-jenkins-user-token', url: 'https://github.com/draios/sysdig']]])
					sh "git checkout ${params.SYSDIG_BRANCH}"
				}
			}
		}
		stage('Build Sysdig') {
			steps {
				dir('sysdig-build') {
					sh label: '', script: '''
						cmake ../sysdig
						make -j $(nproc)
					'''
				}
			}
		}
		stage('Build Agent') {
			steps {
				 build job:'agent-presubmit-system',parameters:[string(name:'SYSDIG_BRANCH', value: "${env.SYSDIG_BRANCH}"),string(name:'AGENT_BRANCH', value: "${env.AGENT_BRANCH}"),string(name:'FALCO_BRANCH', value: "${env.FALCO_BRANCH}"),string(name:'BUILDER_VERSION', value: "${env.BUILDER_VERSION}"),]
			}
			post {
				failure {
					 slackSend channel: '#ws-agent-core-team', message: "Sysdig Branch ${params.SYSDIG_BRANCH} breaks agent build", tokenCredentialId: 'slack'
				}
			}
		}
	}
	post {
		always {
			cleanWs deleteDirs: true, notFailBuild: true
		}
	}
}
