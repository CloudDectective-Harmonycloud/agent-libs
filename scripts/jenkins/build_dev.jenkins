/* vim:expandtab:sw=4:ts=4:sts=4
*/

pipeline {
    agent { label 'agent-docker-builder' }
    parameters {
        string(name: 'AGENT_BRANCH', defaultValue: 'dev', trim: true)
        string(name: 'SYSDIG_BRANCH', defaultValue: 'dev', trim: true)
        string(name: 'FALCO_BRANCH', defaultValue: 'master-sync', trim: true)
        string(name: 'PROTOREPO_BRANCH', defaultValue: 'master', trim: true)
        booleanParam(name: 'UPLOAD', defaultValue: false, description: 'set to upload this to the s3 bucket. ONLY use during actual release')
        string(name: 'RELEASE_VERSION', defaultValue: '0.DEV-TEST', trim: true)
        string(name: 'BUILDER_VERSION', defaultValue: 'latest', trim: true, description: 'version of the builder to use')
        booleanParam(name: 'PUBLIC_RELEASE', defaultValue: false, description: 'set to use production RC bucket instead of internal')
        string(name: 'LIBSINSP_BRANCH', defaultValue: 'dev', trim: true)
        string(name: 'LIBSCAP_BRANCH', defaultValue: 'dev', trim: true)
        string(name: 'LIBS_BRANCH', defaultValue: 'dev', trim: true)
        booleanParam(name: 'USE_LEGACY_LIBS', defaultValue: false, description: 'set to upload this to the s3 bucket. ONLY use during actual release')
    }
    stages {
        stage('Check out dependencies') {
           steps {
                dir('agent') {
                    checkout scm
                    sh "git checkout ${params.AGENT_BRANCH}"
                }
                dir('oss-falco') {
                    checkout([$class: 'GitSCM', branches: [[name: 'master-sync']], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: 'github-jenkins-user-token', url: 'https://github.com/draios/oss-falco']]])
                    sh "git checkout ${params.FALCO_BRANCH}"
                }
                dir('libsinsp') {
                    checkout([$class: 'GitSCM', branches: [[name: 'dev']], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: 'github-jenkins-user-token', url: 'https://github.com/draios/libsinsp']]])
                    sh "git checkout ${params.LIBSINSP_BRANCH}"
                }
                dir('libscap') {
                    checkout([$class: 'GitSCM', branches: [[name: 'dev']], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: 'github-jenkins-user-token', url: 'https://github.com/draios/libscap']]])
                    sh "git checkout ${params.LIBSCAP_BRANCH}"
                }
                dir('protorepo') {
                    checkout([$class: 'GitSCM', branches: [[name: 'master']], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: 'github-jenkins-user-token', url: 'https://github.com/draios/protorepo']]])
                    sh "git checkout ${params.PROTOREPO_BRANCH}"
                }
                dir('agent-libs') {
                    checkout([$class: 'GitSCM', branches: [[name: 'dev']], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: 'github-jenkins-user-token', url: 'https://github.com/draios/agent-libs']]])
                    sh "git checkout ${params.LIBS_BRANCH}"
                }
            }
        }
        stage('Build Release') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'docker-hub', passwordVariable: 'DOCKER_PASSWORD', usernameVariable: 'DOCKER_USERNAME'), usernamePassword(credentialsId: 'QUAY', passwordVariable: 'QUAY_PASSWORD', usernameVariable: 'QUAY_USERNAME')]) {
                    sh label: '', script: '''
                        echo "$QUAY_PASSWORD" | docker login quay.io -u="$QUAY_USERNAME" --password-stdin
                        docker pull quay.io/sysdig/agent-builder:$BUILDER_VERSION
                        sudo rm -rf $PWD/out
                        docker run -i --rm -e MAKE_JOBS=$(nproc) -e AGENT_VERSION=$RELEASE_VERSION -v $PWD:/draios:ro -v $PWD/out:/out -v /var/run/docker.sock:/var/run/docker.sock -v $PWD/pipcache:/root/.cache -e USE_OLD_DIRS=$USE_LEGACY_LIBS quay.io/sysdig/agent-builder:$BUILDER_VERSION release
                    '''
                }
            }
        }
        stage('Upload Packages') {
            when {
                expression { params.UPLOAD == true }
            }
            steps {
                sh label: '', script: '''
                    sudo agent/scripts/jenkins/upload-agent dev $PWD/out $PWD/repo "s3://download.draios.com" $RELEASE_VERSION release
                    sudo agent/scripts/jenkins/upload-agent dev-debug $PWD/out $PWD/repo "s3://download.draios.com" $RELEASE_VERSION debug
                '''
            }
        }
        stage('Build Prod Containers') {
            when {
                expression { params.UPLOAD == true }
            }
            steps {
                script {
                    docker.withRegistry("https://docker.internal.sysdig.com", 'jenkins-artifactory') {
                        sh label: '', script: '''
                            sudo agent/scripts/jenkins/build-prod-container dev $PWD/out
                        '''
                    }
                }
            }
        }
        stage('Upload Prod Containers'){
            when {
                expression { params.UPLOAD == true }
            }
            steps {
                withCredentials([usernamePassword(credentialsId: 'docker-hub', passwordVariable: 'DOCKER_PASSWORD', usernameVariable: 'DOCKER_USERNAME')]) {
                    script {
                        docker.withRegistry("https://docker.internal.sysdig.com", 'jenkins-artifactory') {
                            sh label: '', script: '''
                                echo "$DOCKER_PASSWORD" | docker login docker.io -u="$DOCKER_USERNAME" --password-stdin
                                docker tag agent sysdig/agent:dev
                                docker tag agent sysdig/agent:$RELEASE_VERSION
                                docker push sysdig/agent
                                docker tag agent-slim sysdig/agent-slim:dev
                                docker tag agent-slim sysdig/agent-slim:$RELEASE_VERSION
                                docker push sysdig/agent-slim

                                docker tag agentone docker.internal.sysdig.com/agentone:dev
                                docker tag agentone docker.internal.sysdig.com/agentone:$RELEASE_VERSION
                                docker push docker.internal.sysdig.com/agentone

                                docker tag agent-kmodule sysdig/agent-kmodule:dev
                                docker tag agent-kmodule sysdig/agent-kmodule:$RELEASE_VERSION
                                docker push sysdig/agent-kmodule

                                docker tag agent-kmodule-thin sysdig/agent-kmodule-thin:dev
                                docker tag agent-kmodule-thin sysdig/agent-kmodule-thin:$RELEASE_VERSION
                                docker push sysdig/agent-kmodule-thin

                                docker tag agent-ubi docker.internal.sysdig.com/agent-ubi:dev
                                docker tag agent-ubi docker.internal.sysdig.com/agent-ubi:$RELEASE_VERSION
                                docker push docker.internal.sysdig.com/agent-ubi

                                docker tag agent-kmodule-ubi docker.internal.sysdig.com/agent-kmodule-ubi:dev
                                docker tag agent-kmodule-ubi docker.internal.sysdig.com/agent-kmodule-ubi:$RELEASE_VERSION
                                docker push docker.internal.sysdig.com/agent-kmodule-ubi

                                docker tag agent-slim-ubi docker.internal.sysdig.com/agent-slim-ubi:dev
                                docker tag agent-slim-ubi docker.internal.sysdig.com/agent-slim-ubi:$RELEASE_VERSION
                                docker push docker.internal.sysdig.com/agent-slim-ubi
                            '''
                        }
                    }
                }
            }
        }
    }
    post {
        always {
            sh label: '', script: '''
                docker rmi agent agent-slim agentone agent-kmodule agent-kmodule-thin || echo "no containers to remove"
                docker rmi -f $(docker images | grep -ve 'quay.io/sysdig/agent-builder.*latest'  | awk 'NR>1 {print $3}') || echo "no containers to remove"
                docker images -q -f 'dangling=true' | xargs --no-run-if-empty docker rmi -f || echo "something something failed"
                sudo rm -rf * .[!.]*
            '''
            cleanWs()
        }
    }
}
